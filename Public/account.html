<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Student Account</title>
  <style>
    /* Styling for the form */
    h2 {
      color: #6C22C9;
    }

    #studentForm {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 10px;
    }

    #studentForm label {
      margin-right: 10px;
    }

    #checkButton {
      background-color: #6C22C9;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
    }

    /* Styling for the account data section */
    #accountData {
      margin-top: 20px;
    }

    h3 {
      color: #6C22C9;
    }

    ul {
      list-style-type: none;
      padding: 0;
    }

    li {
      margin-bottom: 8px;
    }

    #studentForm {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 10px;
    }

    #studentForm label {
      margin-right: 10px;
    }

    #studentID,
    #studentName {
      margin-right: 20px;
    }

    #checkButton {
      background-color: #6C22C9;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
    }

    #deleteButton {
      display: none; /* Initially hidden */
      background-color: #FF4C4C;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
    }

    
  </style>
</head>
<body>
  <h2>Check Student Account:</h2>
  <form id="studentForm">
    <label for="studentID">Student ID:</label>
    <input type="text" id="studentID" name="studentID" required>
    <label for="studentName">Student Name:</label>
    <input type="text" id="studentName" name="studentName" required>
    <button type="submit" id="checkButton">Check</button>
  </form>
  <br>
  <hr>

  <div id="accountData"></div>

  <!-- Assuming this container holds the list of books -->
  <div id="booksContainer"></div>

  <button id="deleteButton">Delete Account</button>

  <script>
    document.getElementById("studentForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const studentID = document.getElementById("studentID").value;
      const studentName = document.getElementById("studentName").value;

      fetch('/check-account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ studentID, studentName })
      })
      .then(response => response.json())
      .then(result => {
        const accountDataDiv = document.getElementById("accountData");
        accountDataDiv.innerHTML = "";

        if (result.accountFound) {
          const { studentID, studentName, program, semester, books } = result.accountData;
          const html = `
            <h3>Account Data:</h3>
            <p><strong>Student ID:</strong> ${studentID}</p>
            <p><strong>Student Name:</strong> ${studentName}</p>
            <p><strong>Program:</strong> ${program}</p>
            <p><strong>Semester:</strong> ${semester}</p>
          `;

          if (books && books.length > 0) {
            const booksHtml = `
              <h4>Books:</h4>
              <ul>
                ${books.map(book => `<li>${book.bookName} - Issued Date: ${book.bookIssuedDate}<button id="removeIssuedBookbtn" style="margin-left: 10px;" type="button" onclick="removeIssuedBook(this)">-</button></li>`).join('')}
              </ul>
            `;
            accountDataDiv.innerHTML = html + booksHtml;
          } else {
            accountDataDiv.innerHTML = html + "<p>No books issued.</p>";
          }

        

          // Show the "Delete Account" button
          document.getElementById("deleteButton").style.display = "inline-block";
        } else {
          accountDataDiv.innerHTML = "<p>Account not found.</p>";
          // Hide the "Delete Account" button if no account found
          document.getElementById("deleteButton").style.display = "none";
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById("accountData").innerHTML = "<p>An error occurred while checking the account.</p>";
      });
    });


    function removeIssuedBook(studentID, bookName) {
  // Send an API request to delete the book from the database
  fetch(`/remove-book/${encodeURIComponent(studentID)}/${encodeURIComponent(bookName)}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
    },
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Failed to delete the book from the database. Server responded with status: ${response.status}`);
    }
    // Book successfully deleted from the database, now update the UI
    updateBooksUI();
  })
  .catch(error => {
    console.error(error);
    alert('Failed to remove the book. Please try again later.');
  });
}



// Function to update the UI with the list of books
function updateBooksUI() {
  // Send an API request to get the updated list of books from the server
  fetch('/get-books')
    .then(response => response.json())
    .then(data => {
      books = data; // Assuming the server sends the list of books in the response
      // Generate the HTML for the books list
      const booksHtml = `
        <h4>Books:</h4>
        <ul>
          ${books.map(book => `
            <li>
              ${book.Book_Name} - Issued Date: ${book.Book_Issued_Date}
              <button
                style="margin-left: 10px;"
                type="button"
                onclick="removeIssuedBook('${book.Student_ID}', '${book.Book_Name}')"
              >
                -
              </button>
            </li>
          `).join('')}
        </ul>
      `;

      // Update the books container with the new HTML
      const booksContainer = document.getElementById('booksContainer');
      booksContainer.innerHTML = booksHtml;
    })
    .catch(error => {
      console.error(error);
    });
}

// Initial update of the UI
updateBooksUI();


    document.getElementById("deleteButton").addEventListener("click", function() {
        const studentID = document.getElementById("studentID").value;
        if (confirm(`Are you sure you want to delete the account for Student ID: ${studentID}? This action cannot be undone.`)) {
          // Send a DELETE request to the server to delete the account
          fetch(`/delete-account/${studentID}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(result => {
            // Display the result message
            alert(result.message);
            // Clear the account data div after successful deletion
            document.getElementById("accountData").innerHTML = "";
            // Hide the "Delete Account" button after successful deletion
            document.getElementById("deleteButton").style.display = "none";
          })
          .catch(error => {
            console.error('Error:', error);
            alert("An error occurred while deleting the account.");
          });
        }
      }); 


  </script>     
  

    
</body>
</html>
